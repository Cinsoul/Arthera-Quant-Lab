<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artheraé‡åŒ–äº¤æ˜“ç³»ç»Ÿ - æŠ•èµ„è€…æ¼”ç¤ºå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .number-counter {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="gradient-bg text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold">Arthera é‡åŒ–äº¤æ˜“</h1>
                <span class="bg-green-500 text-xs px-2 py-1 rounded-full flex items-center">
                    <span class="w-2 h-2 bg-white rounded-full mr-1 pulse-dot"></span>
                    ç³»ç»Ÿè¿è¡Œä¸­
                </span>
            </div>
            <div class="text-right">
                <div class="text-sm opacity-90">æŠ•èµ„è€…æ¼”ç¤ºå¹³å°</div>
                <div class="text-xs" id="current-time"></div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- æ ¸å¿ƒæŒ‡æ ‡ä»ªè¡¨æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">ä»Šæ—¥äº¤æ˜“é‡</p>
                        <p class="text-3xl font-bold text-blue-600 number-counter" id="total-volume">-</p>
                    </div>
                    <div class="text-blue-500">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-green-600 text-sm" id="volume-change">-</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">æ´»è·ƒç­–ç•¥</p>
                        <p class="text-3xl font-bold text-green-600 number-counter" id="active-strategies">-</p>
                    </div>
                    <div class="text-green-500">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-green-600 text-sm">å…¨éƒ¨è¿è¡Œä¸­</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">ä»Šæ—¥ä¿¡å·</p>
                        <p class="text-3xl font-bold text-purple-600 number-counter" id="signals-today">-</p>
                    </div>
                    <div class="text-purple-500">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-purple-600 text-sm" id="signal-strength">-</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">æˆåŠŸç‡</p>
                        <p class="text-3xl font-bold text-orange-600 number-counter" id="success-rate">-</p>
                    </div>
                    <div class="text-orange-500">
                        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-orange-600 text-sm">ä¸“ä¸šæ°´å‡†</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ç­–ç•¥æ§åˆ¶é¢æ¿ -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ’¡ ç­–ç•¥è¿è¡Œæ§åˆ¶</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¿è¡Œç­–ç•¥</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" checked class="strategy-checkbox" data-strategy="deepseek_alpha">
                                <span class="ml-2">ğŸ§  DeepSeek Alphaç­–ç•¥</span>
                                <span class="ml-auto text-green-600 text-sm">Sharpe: 2.1</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="strategy-checkbox" data-strategy="bayesian_momentum">
                                <span class="ml-2">ğŸ“Š BayesianåŠ¨é‡ç­–ç•¥</span>
                                <span class="ml-auto text-green-600 text-sm">Sharpe: 1.9</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="strategy-checkbox" data-strategy="kelly_optimizer">
                                <span class="ml-2">ğŸ¯ Kellyä¼˜åŒ–ç­–ç•¥</span>
                                <span class="ml-auto text-green-600 text-sm">Sharpe: 1.8</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="strategy-checkbox" data-strategy="risk_parity">
                                <span class="ml-2">âš–ï¸ é£é™©å¹³ä»·ç­–ç•¥</span>
                                <span class="ml-auto text-green-600 text-sm">Sharpe: 1.6</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¿è¡Œæ¨¡å¼</label>
                        <select id="run-mode" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="live">å®æ—¶äº¤æ˜“æ¨¡å¼</option>
                            <option value="backtest">å†å²å›æµ‹æ¨¡å¼</option>
                            <option value="demo">æ¼”ç¤ºæ¨¡å¼</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡è‚¡ç¥¨æ± </label>
                        <select id="pool-select" class="w-full p-2 border border-gray-300 rounded-md mb-3">
                            <option value="">é€‰æ‹©é¢„è®¾è‚¡ç¥¨æ± ...</option>
                        </select>
                        <div id="pool-chips" class="flex flex-wrap gap-2 mb-3 text-sm text-gray-700">
                            <span class="text-gray-400">é€‰æ‹©è‚¡ç¥¨æ± åæ˜¾ç¤ºæˆåˆ†è‚¡</span>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ™ºèƒ½æœç´¢è‚¡ç¥¨</label>
                        <div class="relative mb-3">
                            <input type="text" id="symbol-search" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°ï¼Œè‡ªåŠ¨è¡¥å…¨"
                                   class="w-full p-2 border border-gray-300 rounded-md" autocomplete="off">
                            <div id="search-results" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-10 hidden"></div>
                        </div>
                        <input type="text" id="target-symbols" value="AAPL,TSLA,NVDA,MSFT,GOOGL" 
                               class="w-full p-2 border border-gray-300 rounded-md"
                               placeholder="è‡ªå®šä¹‰è‚¡ç¥¨ä»£ç ï¼Œé€—å·åˆ†éš”">
                        <p class="text-xs text-gray-500 mt-1">å¯é€‰æ‹©é¢„è®¾è‚¡ç¥¨æ± ã€ä½¿ç”¨æ™ºèƒ½æœç´¢æˆ–æ‰‹åŠ¨è¾“å…¥ï¼›ç³»ç»Ÿå°†åˆå¹¶å»é‡ã€‚</p>
                        <div id="custom-chips" class="flex flex-wrap gap-2 mt-2 text-sm"></div>
                    </div>

                    <div class="flex space-x-4">
                        <button id="start-trading" class="flex-1 bg-green-600 text-white p-3 rounded-md font-medium hover:bg-green-700 transition">
                            ğŸš€ å¼€å§‹è¿è¡Œ
                        </button>
                        <button id="stop-trading" class="flex-1 bg-red-600 text-white p-3 rounded-md font-medium hover:bg-red-700 transition">
                            â¹ï¸ åœæ­¢è¿è¡Œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶äº¤æ˜“æ•°æ® -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ“ˆ å®æ—¶äº¤æ˜“æ•°æ®</h2>
                
                <div class="space-y-4">
                    <div>
                        <canvas id="volume-chart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-2xl font-bold text-blue-600 number-counter" id="orders-today">-</p>
                            <p class="text-sm text-gray-600">ä»Šæ—¥è®¢å•</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-2xl font-bold text-green-600 number-counter" id="sharpe-ratio">-</p>
                            <p class="text-sm text-gray-600">Sharpeæ¯”ç‡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€æ–°ä¿¡å·å’Œè®¢å• -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <!-- æœ€æ–°ä¿¡å· -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ¯ æœ€æ–°äº¤æ˜“ä¿¡å·</h2>
                <div id="recent-signals" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æœ€æ–°è®¢å• -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ’¼ æœ€æ–°æˆäº¤è®¢å•</h2>
                <div id="recent-orders" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç­–ç•¥è¡¨ç°è¯¦æƒ… -->
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-bold mb-4">âš™ï¸ ç­–ç•¥è¡¨ç°è¯¦æƒ…</h2>
            <div id="strategy-performance">
                <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- é«˜çº§å›¾è¡¨ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ“Š ç´¯è®¡æ”¶ç›Š vs åŸºå‡†</h2>
                <div class="h-64">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ“‰ å›æ’¤æ›²çº¿</h2>
                <div class="h-64">
                    <canvas id="drawdown-chart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4">ğŸ§­ èµ„äº§/è¡Œä¸šåˆ†é…</h2>
                <div class="h-64">
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- é£é™©ä¸æŠ¥è¡¨ -->
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-bold mb-4">ğŸ›¡ï¸ é£é™©ä¸ç»©æ•ˆæŠ¥è¡¨</h2>
            <div id="risk-report" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è‚¡ç¥¨æ± æ¦‚è§ˆ -->
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-bold mb-4">ğŸ“‚ è‚¡ç¥¨æ± æ¦‚è§ˆ</h2>
            <div id="pool-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 py-6">é€‰æ‹©è‚¡ç¥¨æ± ä»¥æŸ¥çœ‹ç»Ÿè®¡</div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div id="status-toast" class="fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hidden">
        <p id="toast-message">ç³»ç»Ÿæ¶ˆæ¯</p>
    </div>

    
    <script>
        const CLIENT_CONFIG = window.__TRADING_ENGINE_CONFIG__ || {};
        const API_BASE_URL = CLIENT_CONFIG.apiBaseUrl || window.location.origin;
        const DEFAULT_WS_PATH = CLIENT_CONFIG.wsPath || '/ws';
        const ROUTES = {
            signalsRecent: (limit = 10) => buildRoute('/signals/recent', { limit }),
            ordersHistory: (limit = 10) => buildRoute('/orders/history', { limit }),
            strategiesList: () => buildRoute('/strategies/list'),
            generateSignals: () => buildRoute('/signals/generate'),
            symbolPools: () => buildRoute('/universe/pools'),
            poolDetails: (poolId) => buildRoute(`/universe/pools/${poolId}`),
            symbolSearch: (query) => buildRoute('/universe/search', { query }),
            dashboardOverview: () => buildRoute('/dashboard/overview')
        };

        const state = {
            tradingActive: true,
            signals: [],
            orders: [],
            strategies: [],
            dashboard: {},
            pools: [],
            selectedPool: null,
            poolDetails: null,
            customSymbols: [],
            customSymbolMeta: {},
            searchResults: []
        };

        let volumeChart;
        let performanceChart;
        let drawdownChart;
        let allocationChart;
        let websocket;
        let reconnectAttempts = 0;
        let updateInterval;
        let searchTimeout = null;

        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            bindEventListeners();
            loadSymbolPools();
            syncCustomSymbolsFromInput();
            startDataUpdates();
            connectWebSocket();
            showToast('ç³»ç»Ÿå·²è¿æ¥ï¼Œæ•°æ®åŠ è½½ä¸­...', 'success');
        });

        function buildRoute(path, params = {}) {
            const url = new URL(path, API_BASE_URL);
            Object.entries(params).forEach(([key, value]) => {
                if (value !== undefined && value !== null && value !== '') {
                    url.searchParams.set(key, value);
                }
            });
            return url.toString();
        }

        function startDataUpdates() {
            updateCurrentTime();
            refreshAll();
            updateInterval = setInterval(() => {
                refreshAll();
                updateCurrentTime();
            }, 5000);
        }

        function refreshAll() {
            updateOverview();
            updateSignals();
            updateOrders();
            updateStrategies();
        }

        function initializeCharts() {
            initVolumeChart();
            initPerformanceChart();
            initDrawdownChart();
            initAllocationChart();
        }

        function initVolumeChart() {
            const ctx = document.getElementById('volume-chart').getContext('2d');
            volumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æˆäº¤é‡',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + Number(value || 0).toLocaleString()
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function initPerformanceChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ç»„åˆæ”¶ç›Š',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16,185,129,0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'åŸºå‡†æ”¶ç›Š',
                            data: [],
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99,102,241,0.1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => (value * 100).toFixed(1) + '%'
                            }
                        }
                    }
                }
            });
        }

        function initDrawdownChart() {
            const ctx = document.getElementById('drawdown-chart').getContext('2d');
            drawdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å›æ’¤',
                        data: [],
                        backgroundColor: '#f97316'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: value => (value * 100).toFixed(1) + '%'
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function initAllocationChart() {
            const ctx = document.getElementById('allocation-chart').getContext('2d');
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'é…ç½®',
                        data: [],
                        backgroundColor: ['#1d4ed8', '#10b981', '#f59e0b', '#6366f1', '#ef4444', '#a855f7']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        async function fetchJSON(url, options = {}) {
            const controller = new AbortController();
            const timeout = options.timeout ?? 10000;
            const fetchOptions = { ...options, signal: controller.signal };
            delete fetchOptions.timeout;
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }
                return await response.json();
            } finally {
                clearTimeout(timer);
            }
        }

        async function updateOverview() {
            try {
                const overview = await fetchJSON(ROUTES.dashboardOverview());
                state.dashboard = overview;
                applyDashboardData(overview.system_status, overview.trading_stats);
                updatePerformanceChart(overview.performance_series);
                updateDrawdownChart(overview.drawdown);
                updateAllocationChart(overview.allocations);
                renderRiskReport(overview.risk_report);
            } catch (error) {
                console.error('æ›´æ–°ä»ªè¡¨æ¿å¤±è´¥:', error);
                showToast('ä»ªè¡¨æ¿åˆ·æ–°å¤±è´¥', 'error');
            }
        }

        function applyDashboardData(statusData, statsData) {
            if (statusData) {
                document.getElementById('total-volume').textContent = '$' + Number(statusData.total_volume || 0).toLocaleString();
                document.getElementById('active-strategies').textContent = statusData.strategies_running ?? '-';
                document.getElementById('signals-today').textContent = statusData.signals_today ?? '-';
                document.getElementById('success-rate').textContent = `${Number(statusData.success_rate || 0).toFixed(1)}%`;
                updateVolumeChart(statusData.total_volume || 0);
            }

            const stats = statsData?.daily_stats;
            if (stats) {
                document.getElementById('orders-today').textContent = stats.trades_executed ?? '-';
            }

            const performance = statsData?.performance;
            if (performance) {
                document.getElementById('sharpe-ratio').textContent = performance.sharpe_ratio ?? '-';
            }
        }

        function updateVolumeChart(volume) {
            const timestamp = new Date().toLocaleTimeString();
            const maxPoints = 30;

            if (volumeChart.data.labels.length >= maxPoints) {
                volumeChart.data.labels.shift();
                volumeChart.data.datasets[0].data.shift();
            }

            volumeChart.data.labels.push(timestamp);
            volumeChart.data.datasets[0].data.push(Number(volume || 0));
            volumeChart.update('none');
        }

        function updatePerformanceChart(data) {
            if (!performanceChart) return;
            const portfolioSeries = data.portfolio || [];
            const benchmarkSeries = data.benchmark || [];
            const labels = portfolioSeries.map(point => new Date(point.timestamp).toLocaleDateString());

            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = portfolioSeries.map(point => (point.value || 1) - 1);
            performanceChart.data.datasets[1].data = benchmarkSeries.map(point => (point.value || 1) - 1);
            performanceChart.update('none');
        }

        function updateDrawdownChart(data) {
            if (!drawdownChart) return;
            const series = data.series || [];
            drawdownChart.data.labels = series.map(point => new Date(point.timestamp).toLocaleDateString());
            drawdownChart.data.datasets[0].data = series.map(point => point.value || 0);
            drawdownChart.update('none');
        }

        function updateAllocationChart(data) {
            if (!allocationChart) return;
            const sectors = data.by_sector || [];
            allocationChart.data.labels = sectors.map(item => item.label || '');
            allocationChart.data.datasets[0].data = sectors.map(item => Number(item.value || 0));
            allocationChart.update('none');
        }

        async function loadSymbolPools() {
            try {
                const data = await fetchJSON(ROUTES.symbolPools());
                state.pools = data.pools || [];
                renderPoolOptions();
            } catch (error) {
                console.error('åŠ è½½è‚¡ç¥¨æ± å¤±è´¥:', error);
            }
        }

        function renderPoolOptions() {
            const select = document.getElementById('pool-select');
            select.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾è‚¡ç¥¨æ± ...</option>';
            state.pools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool.id;
                option.textContent = `${pool.name} (${pool.symbol_count || 0})`;
                select.appendChild(option);
            });
        }

        async function handlePoolSelection(event) {
            const poolId = event.target.value;
            state.selectedPool = poolId || null;
            if (!poolId) {
                state.poolDetails = null;
                renderPoolChips([]);
                renderPoolStats(null);
                return;
            }
            try {
                const details = await fetchJSON(ROUTES.poolDetails(poolId));
                state.poolDetails = details;
                const entries = details.components && details.components.length ? details.components : (details.symbols || []);
                renderPoolChips(entries);
                renderPoolStats(details);
            } catch (error) {
                console.error('è·å–è‚¡ç¥¨æ± è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        function renderPoolChips(symbolsOrComponents) {
            const container = document.getElementById('pool-chips');
            container.innerHTML = '';
            if (!symbolsOrComponents || !symbolsOrComponents.length) {
                container.innerHTML = '<span class="text-gray-400">é€‰æ‹©è‚¡ç¥¨æ± åæ˜¾ç¤ºæˆåˆ†è‚¡</span>';
                return;
            }

            symbolsOrComponents.slice(0, 12).forEach(item => {
                const symbol = typeof item === 'string' ? item : item.symbol;
                const name = typeof item === 'string' ? '' : (item.name || '');
                const price = typeof item === 'string' ? '' : (item.last_price ? `$${Number(item.last_price).toFixed(2)}` : '');
                const detail = name || price ? `<span class="text-xs text-gray-500">${name} ${price}</span>` : '';
                const entry = document.createElement('div');
                entry.className = 'px-3 py-2 bg-indigo-50 text-indigo-800 rounded-lg text-xs flex flex-col';
                entry.innerHTML = `<span class="font-semibold">${symbol}</span>${detail}`;
                container.appendChild(entry);
            });

            if (symbolsOrComponents.length > 12) {
                const extra = document.createElement('span');
                extra.className = 'text-xs text-gray-500';
                extra.textContent = `+${symbolsOrComponents.length - 12} ...`;
                container.appendChild(extra);
            }
        }

        function renderPoolStats(details) {
            const container = document.getElementById('pool-stats');
            if (!details) {
                container.innerHTML = '<div class="text-center text-gray-500 py-6">é€‰æ‹©è‚¡ç¥¨æ± ä»¥æŸ¥çœ‹ç»Ÿè®¡</div>';
                return;
            }

            const stats = details.stats || {};
            const sectors = details.sector_distribution || [];

            const metricsHtml = `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-500">å¹³å‡Beta</div>
                    <div class="text-2xl font-bold text-gray-800">${(stats.avg_beta ?? '-')}</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-500">å¹³å‡æˆäº¤é‡</div>
                    <div class="text-2xl font-bold text-gray-800">${stats.avg_volume ? (stats.avg_volume / 1_000_000).toFixed(1) + 'M' : '-'}</div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-500">è¿‘3ä¸ªæœˆåŠ¨é‡</div>
                    <div class="text-2xl font-bold ${Number(stats.momentum_3m || 0) >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${(Number(stats.momentum_3m || 0) * 100).toFixed(1)}%
                    </div>
                </div>
            `;

            const sectorHtml = sectors.length ? `
                <div class="md:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                    ${sectors.map(item => `
                        <div class="p-3 border border-gray-100 rounded-lg text-center">
                            <div class="text-sm text-gray-500">${item.label}</div>
                            <div class="text-lg font-semibold">${(Number(item.value || 0) * 100).toFixed(1)}%</div>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            const components = details.components || [];
            const componentsHtml = components.length ? `
                <div class="md:col-span-3 mt-4">
                    <h4 class="text-sm text-gray-500 mb-2">ä»£è¡¨æˆåˆ†è‚¡</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${components.slice(0, 4).map(item => `
                            <div class="p-3 border border-gray-100 rounded-lg">
                                <div class="flex justify-between text-sm font-semibold">${item.symbol}<span>${item.last_price ? '$' + Number(item.last_price).toFixed(2) : ''}</span></div>
                                <div class="text-xs text-gray-500">${item.name || ''}</div>
                                <div class="text-xs text-gray-400">${item.sector || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            container.innerHTML = metricsHtml + sectorHtml + componentsHtml;
        }

        function handleSearchInput(event) {
            const term = event.target.value.trim();
            clearTimeout(searchTimeout);
            if (term.length < 2) {
                hideSearchResults();
                return;
            }
            searchTimeout = setTimeout(() => performSymbolSearch(term), 250);
        }

        async function performSymbolSearch(term) {
            try {
                const data = await fetchJSON(ROUTES.symbolSearch(term));
                state.searchResults = data.results || [];
                renderSearchResults(term);
            } catch (error) {
                console.error('æœç´¢è‚¡ç¥¨å¤±è´¥:', error);
                hideSearchResults();
            }
        }

        function renderSearchResults(term) {
            const dropdown = document.getElementById('search-results');
            if (!state.searchResults.length) {
                dropdown.innerHTML = `<div class="p-3 text-sm text-gray-500">æœªæ‰¾åˆ°ä¸ "${term}" åŒ¹é…çš„è‚¡ç¥¨</div>`;
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = state.searchResults.slice(0, 8).map(result => {
                const price = result.last_price ? `$${Number(result.last_price).toFixed(2)}` : '-';
                const change = result.change_pct ? (result.change_pct * 100).toFixed(2) + '%' : '-';
                const changeColor = result.change_pct >= 0 ? 'text-green-600' : 'text-red-600';
                return `
                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" data-symbol="${result.symbol}">
                        <div class="flex justify-between">
                            <span class="font-semibold">${result.symbol}</span>
                            <span class="text-sm ${changeColor}">${change}</span>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between">
                            <span>${result.name || ''} Â· ${result.exchange || ''}</span>
                            <span>${price}</span>
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.querySelectorAll('[data-symbol]').forEach(item => {
                item.addEventListener('click', () => {
                    const symbol = item.getAttribute('data-symbol');
                    const meta = state.searchResults.find(entry => entry.symbol === symbol);
                    addCustomSymbol(meta || symbol);
                    document.getElementById('symbol-search').value = '';
                    hideSearchResults();
                });
            });

            dropdown.classList.remove('hidden');
        }

        function hideSearchResults() {
            const dropdown = document.getElementById('search-results');
            dropdown.classList.add('hidden');
            dropdown.innerHTML = '';
        }

        function syncCustomSymbolsFromInput() {
            const input = document.getElementById('target-symbols');
            const symbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            state.customSymbols = Array.from(new Set(symbols));
            Object.keys(state.customSymbolMeta).forEach(symbol => {
                if (!state.customSymbols.includes(symbol)) {
                    delete state.customSymbolMeta[symbol];
                }
            });
            renderCustomChips();
        }

        function addCustomSymbol(symbolOrDetails) {
            if (!symbolOrDetails) return;
            const normalized = (typeof symbolOrDetails === 'string' ? symbolOrDetails : symbolOrDetails.symbol || '').trim().toUpperCase();
            if (!normalized) return;
            if (!state.customSymbols.includes(normalized)) {
                state.customSymbols.push(normalized);
            }
            if (typeof symbolOrDetails === 'object' && symbolOrDetails.symbol) {
                state.customSymbolMeta[normalized] = symbolOrDetails;
            }
            updateCustomSymbolInput();
        }

        function removeCustomSymbol(symbol) {
            state.customSymbols = state.customSymbols.filter(item => item !== symbol);
            delete state.customSymbolMeta[symbol];
            updateCustomSymbolInput();
        }

        function updateCustomSymbolInput() {
            const input = document.getElementById('target-symbols');
            input.value = state.customSymbols.join(',');
            renderCustomChips();
        }

        function renderCustomChips() {
            const container = document.getElementById('custom-chips');
            if (!state.customSymbols.length) {
                container.innerHTML = '<span class="text-gray-400 text-xs">æš‚æ— è‡ªå®šä¹‰è‚¡ç¥¨</span>';
                return;
            }
            container.innerHTML = state.customSymbols.map(symbol => {
                const meta = state.customSymbolMeta[symbol];
                const name = meta?.name || '';
                const price = meta?.last_price ? `$${Number(meta.last_price).toFixed(2)}` : '';
                return `
                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium flex items-center">
                        <span>
                            <span class="font-semibold">${symbol}</span>
                            ${name || price ? `<span class="ml-1 text-gray-600">${name} ${price}</span>` : ''}
                        </span>
                        <button class="ml-2 text-blue-500 hover:text-blue-700" data-remove-symbol="${symbol}">Ã—</button>
                    </span>
                `;
            }).join('');

            container.querySelectorAll('[data-remove-symbol]').forEach(btn => {
                btn.addEventListener('click', () => removeCustomSymbol(btn.getAttribute('data-remove-symbol')));
            });
        }

        async function updateSignals() {
            try {
                const data = await fetchJSON(ROUTES.signalsRecent());
                state.signals = data.signals || [];
                renderSignals(state.signals);
            } catch (error) {
                console.error('æ›´æ–°ä¿¡å·å¤±è´¥:', error);
            }
        }

        function renderSignals(signals) {
            const container = document.getElementById('recent-signals');
            container.innerHTML = '';

            if (!signals.length) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— ä¿¡å·æ•°æ®</div>';
                return;
            }

            signals.forEach(signal => {
                const actionColor = {
                    'BUY': 'text-green-600',
                    'SELL': 'text-red-600',
                    'HOLD': 'text-yellow-600'
                }[signal.action] || 'text-gray-600';

                const signalDiv = document.createElement('div');
                signalDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                signalDiv.innerHTML = `
                    <div>
                        <span class="font-bold">${signal.symbol || '-'}</span>
                        <span class="${actionColor} ml-2">${signal.action || 'HOLD'}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">ç½®ä¿¡åº¦: ${(Number(signal.confidence || 0) * 100).toFixed(1)}%</div>
                        <div class="text-xs text-gray-500">${signal.strategy || 'N/A'}</div>
                    </div>
                `;
                container.appendChild(signalDiv);
            });
        }

        async function updateOrders() {
            try {
                const data = await fetchJSON(ROUTES.ordersHistory());
                state.orders = data.orders || [];
                renderOrders(state.orders);
            } catch (error) {
                console.error('æ›´æ–°è®¢å•å¤±è´¥:', error);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('recent-orders');
            container.innerHTML = '';

            if (!orders.length) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— è®¢å•æ•°æ®</div>';
                return;
            }

            orders.forEach(order => {
                const sideColor = order.side === 'BUY' ? 'text-green-600' : 'text-red-600';
                const orderDiv = document.createElement('div');
                orderDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                orderDiv.innerHTML = `
                    <div>
                        <span class="font-bold">${order.symbol || '-'}</span>
                        <span class="${sideColor} ml-2">${order.side || '-'}</span>
                        <span class="text-gray-600 ml-2">${order.quantity || 0}è‚¡</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">$${order.fill_price ?? '-'} </div>
                        <div class="text-xs text-gray-500">${order.status || ''}</div>
                    </div>
                `;
                container.appendChild(orderDiv);
            });
        }

        async function updateStrategies() {
            try {
                const data = await fetchJSON(ROUTES.strategiesList());
                state.strategies = data.strategies || [];
                renderStrategies(state.strategies);
            } catch (error) {
                console.error('æ›´æ–°ç­–ç•¥å¤±è´¥:', error);
            }
        }

        function renderStrategies(strategies) {
            const container = document.getElementById('strategy-performance');
            container.innerHTML = '';

            if (!strategies.length) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— ç­–ç•¥æ•°æ®</div>';
                return;
            }

            strategies.forEach(strategy => {
                const returnColor = Number(strategy.daily_return || 0) >= 0 ? 'text-green-600' : 'text-red-600';
                const strategyDiv = document.createElement('div');
                strategyDiv.className = 'grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg mb-3';
                strategyDiv.innerHTML = `
                    <div>
                        <div class="font-bold">${strategy.name || '-'} </div>
                        <div class="text-sm text-gray-600">çŠ¶æ€: ${strategy.status || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold ${returnColor}">${(Number(strategy.daily_return || 0) * 100).toFixed(2)}%</div>
                        <div class="text-xs text-gray-500">æ—¥æ”¶ç›Šç‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600">${strategy.sharpe_ratio ?? '-'}</div>
                        <div class="text-xs text-gray-500">Sharpeæ¯”ç‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-purple-600">${strategy.positions ?? 0}</div>
                        <div class="text-xs text-gray-500">æŒä»“æ•°</div>
                    </div>
                `;
                container.appendChild(strategyDiv);
            });
        }

        function bindEventListeners() {
            document.getElementById('start-trading').addEventListener('click', startTrading);
            document.getElementById('stop-trading').addEventListener('click', stopTrading);
            document.getElementById('pool-select').addEventListener('change', handlePoolSelection);
            document.getElementById('symbol-search').addEventListener('input', handleSearchInput);
            document.getElementById('target-symbols').addEventListener('input', syncCustomSymbolsFromInput);
            document.addEventListener('click', (event) => {
                const searchWrapper = document.getElementById('symbol-search').parentElement;
                if (searchWrapper && !searchWrapper.contains(event.target)) {
                    hideSearchResults();
                }
            });
        }

        async function startTrading() {
            const selectedStrategies = Array.from(document.querySelectorAll('.strategy-checkbox:checked'))
                .map(cb => cb.dataset.strategy);
            syncCustomSymbolsFromInput();
            const manualSymbols = state.customSymbols;
            const poolSymbols = state.poolDetails?.symbols || [];
            const symbols = Array.from(new Set([...poolSymbols, ...manualSymbols]));
            const mode = document.getElementById('run-mode').value;

            try {
                await fetchJSON(ROUTES.generateSignals(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategies: selectedStrategies, symbols, mode })
                });
                showToast('ç­–ç•¥è¿è¡Œå·²è§¦å‘', 'success');
            } catch (error) {
                console.error('å¯åŠ¨ç­–ç•¥å¤±è´¥:', error);
                showToast('å¯åŠ¨ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        function stopTrading() {
            state.tradingActive = false;
            showToast('äº¤æ˜“å·²æš‚åœ', 'warning');
        }

        function connectWebSocket() {
            const wsUrl = CLIENT_CONFIG.wsUrl || buildWebSocketUrl();
            websocket = new WebSocket(wsUrl);

            websocket.onopen = () => {
                reconnectAttempts = 0;
                websocket.send(JSON.stringify({
                    type: 'subscribe',
                    channels: ['system_update', 'new_signals', 'new_order', 'order_execution']
                }));
                showToast('å®æ—¶æ•°æ®è¿æ¥å·²å»ºç«‹', 'success');
            };

            websocket.onmessage = event => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', error);
                }
            };

            websocket.onerror = error => {
                console.error('WebSocketé”™è¯¯:', error);
                showToast('å®æ—¶æ•°æ®è¿æ¥å¼‚å¸¸', 'error');
            };

            websocket.onclose = () => {
                scheduleReconnect();
            };
        }

        function buildWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            return `${protocol}://${window.location.host}${DEFAULT_WS_PATH}`;
        }

        function scheduleReconnect() {
            reconnectAttempts += 1;
            const delay = Math.min(30000, 2000 * reconnectAttempts);
            showToast('å®æ—¶æ•°æ®è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¯•...', 'warning');
            setTimeout(connectWebSocket, delay);
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'welcome':
                    console.log('WebSocketè¿æ¥æˆåŠŸ');
                    break;
                case 'system_update':
                    applyDashboardData(message.data || {});
                    break;
                case 'new_signals':
                    updateSignalsFromWebSocket(message.data);
                    break;
                case 'order_execution':
                case 'new_order':
                    updateOrdersFromWebSocket(message.data);
                    break;
                default:
                    console.log('æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯:', message);
            }
        }

        function updateSignalsFromWebSocket(data) {
            const incoming = Array.isArray(data) ? data : [data];
            state.signals = [...incoming, ...state.signals].slice(0, 10);
            renderSignals(state.signals);
            showToast(`æ”¶åˆ°${incoming.length}ä¸ªæ–°äº¤æ˜“ä¿¡å·`, 'info');
        }

        function updateOrdersFromWebSocket(order) {
            if (!order) return;
            state.orders = [order, ...state.orders].slice(0, 10);
            renderOrders(state.orders);
            showToast(`æ–°è®¢å•: ${order.symbol || ''} ${order.side || ''}`, 'info');
        }

        function renderRiskReport(report) {
            const container = document.getElementById('risk-report');
            if (!report) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— æ•°æ®</div>';
                return;
            }

            const metrics = report.risk_metrics || {};
            const stressTests = report.stress_tests || [];
            const pnlAttribution = report.pnl_attribution || [];

            const metricsList = Object.entries(metrics).map(([key, value]) => {
                const label = key.replace(/_/g, ' ');
                const formatted = typeof value === 'number' ? (Math.abs(value) < 1 ? (value * 100).toFixed(2) + '%' : value.toFixed(2)) : value;
                return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                    <span class="text-gray-600">${label}</span>
                    <span class="font-semibold">${formatted}</span>
                </div>`;
            }).join('');

            const stressList = stressTests.map(item => `
                <div class="flex items-center justify-between text-sm">
                    <span>${item.scenario}</span>
                    <span class="font-medium ${item.impact < 0 ? 'text-red-600' : 'text-green-600'}">${(item.impact * 100).toFixed(2)}%</span>
                </div>
            `).join('');

            const pnlList = pnlAttribution.map(item => `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>${item.category}</span>
                        <span class="font-medium">${(item.value * 100).toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full bg-indigo-500" style="width: ${(item.value * 100).toFixed(1)}%"></div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="space-y-3">
                    <h3 class="font-semibold text-gray-700">é£é™©æŒ‡æ ‡</h3>
                    ${metricsList || '<div class="text-sm text-gray-500">æš‚æ— é£é™©æŒ‡æ ‡</div>'}
                </div>
                <div class="space-y-3">
                    <h3 class="font-semibold text-gray-700">å‹åŠ›æµ‹è¯•</h3>
                    ${stressList || '<div class="text-sm text-gray-500">æš‚æ— å‹åŠ›æµ‹è¯•</div>'}
                    <h3 class="font-semibold text-gray-700 mt-4">æ”¶ç›Šå½’å› </h3>
                    <div class="space-y-3">${pnlList || '<div class="text-sm text-gray-500">æš‚æ— å½’å› æ•°æ®</div>'}</div>
                </div>
            `;
        }

        function showToast(message, type) {
            const toast = document.getElementById('status-toast');
            const messageEl = document.getElementById('toast-message');
            messageEl.textContent = message;
            toast.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white';

            const colorMap = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            toast.classList.add(colorMap[type] || 'bg-blue-600');
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hidden';
            }, 3000);
        }
    </script>

</body>
</html>
