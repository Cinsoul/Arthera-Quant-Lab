# 绘图工具快速测试 - Quick Test Guide

## 🧪 5分钟验证绘图工具功能

### 测试前准备
1. 确保应用正在运行
2. 打开任意带图表的页面（如 Dashboard、StrategyLab 等）
3. 确保图表已加载完成（能看到K线数据）

---

## 📋 测试步骤

### Test 1: 工具栏是否显示 ✅
**预期结果**: 图表左侧应该显示垂直工具栏，包含多个分类按钮

**验证方法**:
```
✓ 查看图表左侧边缘
✓ 应该看到 "SELECTOR", "LINES", "SHAPES" 等按钮
✓ 工具栏应该是深蓝色背景
```

**如果看不到**:
- 检查浏览器窗口宽度（可能被隐藏）
- 查看控制台是否有错误

---

### Test 2: 选择工具激活 ✅
**操作步骤**:
```
1. 点击工具栏顶部的 "SELECTOR" 按钮
2. 观察按钮是否变为高亮状态（蓝色背景）
```

**预期结果**:
- ✓ 按钮背景变为 `#0ea5e9` 蓝色
- ✓ 鼠标在图表上移动时，光标为默认状态
- ✓ 可以正常平移和缩放图表

---

### Test 3: 绘制趋势线 ✅
**操作步骤**:
```
1. 点击工具栏的 "LINES" 分类
2. 在展开的子菜单中选择 "TRENDLINE"
3. 在图表上的 K线低点点击一次（第一个点）
4. 移动鼠标到另一个 K线低点
5. 再次点击（第二个点）
```

**预期结果**:
- ✓ 第一次点击后，应该看到一个临时的半透明线条跟随鼠标移动
- ✓ 第二次点击后，线条变为实线，颜色为 `#0ea5e9`（天蓝色）
- ✓ 线条两端有小圆点（控制点）
- ✓ 按 `Ctrl+Shift+V` 打开调试面板，"Drawing Count" 应该从 0 变为 1

**调试日志检查**:
打开浏览器控制台（F12），应该看到：
```
✏️ handleDrawMouseDown()
🔧 Active Tool: trendline
✅ tempObject created: drawing_xxxxx
✅ mode set to: DRAWING
```

---

### Test 4: 绘制水平线 ✅
**操作步骤**:
```
1. 点击 "LINES" → 选择 "HLINE"
2. 在图表上任意价格位置点击一次
```

**预期结果**:
- ✓ 立即出现一条横跨整个图表宽度的水平线
- ✓ 线条左侧显示价格标签（如 "123.45"）
- ✓ Drawing Count 增加到 2

---

### Test 5: 选择和移动图形 ✅
**操作步骤**:
```
1. 按 ESC 键切换到选择工具（或点击 "SELECTOR"）
2. 点击之前绘制的趋势线
3. 按住鼠标左键拖动
```

**预期结果**:
- ✓ 点击后线条有发光效果（shadowBlur）
- ✓ 控制点变为实心圆点
- ✓ 拖动时整条线跟随鼠标移动
- ✓ 释放鼠标后线条保持新位置

---

### Test 6: 调整图形大小 ✅
**操作步骤**:
```
1. 确保趋势线已选中（有发光效果）
2. 将鼠标移动到线条端点的小圆点上
3. 按住鼠标左键拖动控制点
```

**预期结果**:
- ✓ 只有被拖动的端点移动
- ✓ 另一端保持不变
- ✓ 线条实时更新

---

### Test 7: 删除图形 ✅
**操作步骤**:
```
1. 选中任意图形（点击它）
2. 按 Delete 或 Backspace 键
```

**预期结果**:
- ✓ 图形立即消失
- ✓ Drawing Count 减少 1
- ✓ 控制台显示删除日志

---

### Test 8: 撤销/重做 ✅
**操作步骤**:
```
1. 绘制几个图形（趋势线、水平线等）
2. 按 Ctrl+Z（撤销）
3. 按 Ctrl+Y 或 Ctrl+Shift+Z（重做）
```

**预期结果**:
- ✓ Ctrl+Z 后最后绘制的图形消失
- ✓ 可以连续撤销多次
- ✓ Ctrl+Y 后图形重新出现
- ✓ Drawing Count 相应变化

---

### Test 9: 斐波那契回撤 ✅
**操作步骤**:
```
1. 点击 "TECHNICAL" → 选择 "FIBONACCI"
2. 在K线的波段低点点击（起点）
3. 在K线的波段高点点击（终点）
```

**预期结果**:
- ✓ 出现多条虚线（0%, 23.6%, 38.2%, 50%, 61.8%, 78.6%, 100%）
- ✓ 每条线有不同颜色
- ✓ 右侧显示百分比标签
- ✓ 左侧显示价格值

---

### Test 10: 绘图与图表交互 ✅
**操作步骤**:
```
1. 绘制一条趋势线
2. 使用鼠标滚轮缩放图表
3. 按住 Shift + 拖动鼠标平移图表
```

**预期结果**:
- ✓ 绘图对象随图表缩放保持正确位置（世界坐标系统）
- ✓ 绘图对象随图表平移保持正确位置
- ✓ 绘图对象不会因为缩放而变形或错位

---

## 🔍 调试检查清单

### 如果绘图工具不工作，按以下步骤检查：

#### 1. 打开调试面板
```
按 Ctrl+Shift+V
```

查看以下信息：
- **Drawing Tool**: 应该显示当前选中的工具（如 "trendline"）
- **Drawing Count**: 显示已绘制的图形数量
- **FPS**: 应该 > 30 表示渲染正常

#### 2. 检查控制台日志
```
按 F12 打开开发者工具
切换到 Console 标签页
```

**正常的绘图流程应该看到**:
```
⚙️ DrawingEngine.setTool()
🔧 Tool ID: trendline
✅ activeTool set to: trendline

🖱️ handleMouseMove() - DRAWING MODE
✏️ Drawing in progress
🌍 World Point: t: 1702123456000, p: 123.45
```

**如果看到错误**:
```
❌ Coordinate transforms not initialized
→ 说明坐标转换函数未设置，这是初始化问题

❌ TOOL NOT FOUND OR NO onStart!
→ 说明工具定义有问题，检查 DrawingTools.ts

❌ DrawingEngine not initialized despite canvas being ready
→ 说明 DrawingEngine 初始化失败
```

#### 3. 验证 Canvas 状态
在控制台输入：
```javascript
// 检查 Canvas 是否存在
document.querySelector('canvas')

// 应该返回一个 HTMLCanvasElement 对象
```

#### 4. 验证 DrawingEngine 状态
```
1. 在图表上点击右键 → 审查元素
2. 切换到 React DevTools (如果已安装)
3. 找到 EnhancedTradingChartV2 组件
4. 查看 drawingEngineRef.current 是否存在
```

---

## 🐛 常见问题解决方案

### 问题 1: 点击工具按钮没有反应
**可能原因**:
- 按钮的 onClick 事件未触发
- selectedDrawingTool state 未更新

**解决方法**:
```
1. 打开控制台
2. 点击工具按钮
3. 查看是否有 "DrawingEngine.setTool()" 日志
4. 如果没有，说明 React state 更新有问题
```

### 问题 2: 点击图表无法绘图
**可能原因**:
- DrawingEngine 未初始化
- 坐标转换函数未设置
- Canvas 事件监听器未绑定

**解决方法**:
```
1. 按 Ctrl+Shift+V 查看调试面板
2. 确认 "Drawing Tool" 显示正确的工具名称
3. 在控制台输入: toggleChartDebug()
4. 再次点击图表，查看详细日志
```

### 问题 3: 绘制后立即消失
**可能原因**:
- 未达到最小点数要求
- render() 函数有问题
- Canvas 被重绘覆盖

**解决方法**:
```
1. 检查工具的 minPoints 设置
2. 确保完成了所需的点击次数
   - 趋势线: 需要 2 次点击
   - 水平线: 需要 1 次点击
3. 查看 "Drawing Count" 是否增加
```

### 问题 4: 图形位置不准确
**可能原因**:
- 坐标转换计算错误
- viewport 状态不同步
- 时间轴/价格轴计算问题

**解决方法**:
```
1. 检查控制台的 "World Point" 日志
2. 验证 t (timestamp) 和 p (price) 值是否合理
3. 确认 viewportManagerRef 正常工作
```

---

## ✅ 测试通过标准

完成以上 10 个测试后，如果满足以下条件，说明绘图工具系统运行正常：

- [x] 工具栏正确显示且可以点击
- [x] 至少成功绘制了 3 种不同类型的图形
- [x] 可以选择、移动、调整图形
- [x] 可以删除图形
- [x] 撤销/重做功能正常
- [x] 缩放和平移图表时，绘图位置保持准确
- [x] 调试面板显示正确的 Drawing Count
- [x] 控制台没有报错

---

## 📊 性能基准

**正常性能指标**:
- FPS: > 30 (理想 > 60)
- Render Time: < 16ms (理想 < 10ms)
- Draw Calls: 取决于绘图数量，每个绘图 1 次
- Drawing Count: < 50 时性能最佳

**性能优化建议**:
- 绘图对象 > 100 个时，考虑启用对象池
- 使用 shouldComponentUpdate 减少不必要的重渲染
- 复杂图形（如斐波那契）渲染开销较大，避免大量使用

---

## 🎉 测试完成

如果所有测试通过，恭喜！您的绘图工具系统已完美运行。

**接下来可以**:
- 查看 [DRAWING_TOOLS_GUIDE.md](./DRAWING_TOOLS_GUIDE.md) 了解高级功能
- 尝试组合使用多种工具进行技术分析
- 自定义绘图样式和颜色
- 探索更多 Bloomberg Terminal 级别的专业功能

**如果遇到问题**:
1. 仔细阅读本文档的 "调试检查清单"
2. 查看控制台错误日志
3. 检查 DrawingEngine 初始化状态
4. 验证坐标转换函数是否正常

---

**测试日期**: ___________
**测试人员**: ___________
**测试结果**: [ ] 通过  [ ] 失败  [ ] 部分通过
**备注**: ___________________________________________
