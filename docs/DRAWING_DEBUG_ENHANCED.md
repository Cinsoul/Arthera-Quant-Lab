# ç»˜å›¾å·¥å…·è°ƒè¯•ç³»ç»Ÿå¢å¼ºå®Œæˆ

## å·²å®Œæˆçš„æ”¹è¿›

### 1. DrawingEngineV2.ts å¢å¼ºæ—¥å¿—

åœ¨ `handleMouseDown` æ–¹æ³•ä¸­æ·»åŠ äº†è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯ï¼š

```typescript
public handleMouseDown(x: number, y: number, button: number = 0): void {
  console.log('[DrawingEngine] ========== handleMouseDown ==========');
  console.log('[DrawingEngine] Coordinate transforms available:', {
    screenToWorld: !!this.screenToWorld,
    worldToScreen: !!this.worldToScreen,
  });
  console.log('[DrawingEngine] Current state:', {
    activeTool: this.state.activeTool,
    mode: this.state.mode,
    button
  });
  
  // ... å…¶ä½™é€»è¾‘
  
  console.log('[DrawingEngine] After mouseDown, mode is now:', this.state.mode);
}
```

**å…³é”®è¯Šæ–­ç‚¹**:
- âœ… åæ ‡è½¬æ¢å‡½æ•°æ˜¯å¦å·²è®¾ç½®
- âœ… å½“å‰æ¿€æ´»çš„å·¥å…·
- âœ… å½“å‰äº¤äº’æ¨¡å¼
- âœ… mouseDownåçš„æ¨¡å¼çŠ¶æ€

### 2. EnhancedTradingChartV2.tsx å¢å¼ºæ—¥å¿—

åœ¨ `handleMouseMove` æ–¹æ³•ä¸­æ·»åŠ äº†çŠ¶æ€è¿½è¸ªï¼š

```typescript
if (drawingEngineRef.current) {
  const shouldBlock = drawingEngineRef.current.handleMouseMove(x, y);
  if (shouldBlock) {
    console.log('[Chart] handleMouseMove - DrawingEngine blocking interaction (drawing in progress)');
    console.log('[Chart] â†’ Skipping pan and hover updates');
    return;
  }
  console.log('[Chart] handleMouseMove - DrawingEngine returned FALSE, continuing with normal interactions');
}
```

**å…³é”®è¯Šæ–­ç‚¹**:
- âœ… DrawingEngineæ˜¯å¦é˜»æ­¢äº†äº¤äº’
- âœ… æ˜¯å¦è·³è¿‡äº†å¹³ç§»å’Œhoveræ›´æ–°
- âœ… æ˜¯å¦ç»§ç»­æ‰§è¡Œæ­£å¸¸äº¤äº’é€»è¾‘

## å®Œæ•´çš„è°ƒè¯•æµç¨‹

### ç”¨æˆ·æ“ä½œåºåˆ—

1. **é€‰æ‹©ç»˜å›¾å·¥å…·** â†’ ç‚¹å‡»å·¦ä¾§å·¥å…·æ çš„è¶‹åŠ¿çº¿æŒ‰é’®
2. **åœ¨ç”»å¸ƒä¸ŠæŒ‰ä¸‹é¼ æ ‡** â†’ å¼€å§‹ç»˜å›¾çš„ç¬¬ä¸€ä¸ªç‚¹
3. **æ‹–åŠ¨é¼ æ ‡** â†’ é¢„è§ˆç»˜å›¾
4. **æŠ¬èµ·é¼ æ ‡** â†’ å®Œæˆç»˜å›¾

### é¢„æœŸçš„æ§åˆ¶å°è¾“å‡º

#### åœºæ™¯ A: æ­£å¸¸å·¥ä½œï¼ˆç»˜å›¾æˆåŠŸï¼‰

```
[Chart] ========== Drawing Tool Changed ==========
[Chart] New selectedDrawingTool: trendline
[DrawingEngine] setTool called: trendline
[DrawingEngine] activeTool set to: trendline

[Chart] ========== handleMouseDown ==========
[Chart] selectedDrawingTool: trendline
[DrawingEngine] ========== handleMouseDown ==========
[DrawingEngine] Coordinate transforms available: { screenToWorld: true, worldToScreen: true }
[DrawingEngine] Current state: { activeTool: 'trendline', mode: 'idle', button: 0 }
[DrawingEngine] â†’ Calling handleDrawMouseDown
[DrawingEngine] tool found: YES (è¶‹åŠ¿çº¿)
[DrawingEngine] âœ… tempObject created
[DrawingEngine] âœ… mode set to: drawing
[DrawingEngine] After mouseDown, mode is now: drawing
[Chart] Non-select tool detected! Tool: trendline
[Chart] BLOCKING pan - isDragging will NOT be set to true

[DrawingEngine] handleMouseMove - mode: drawing
[DrawingEngine] Drawing mode active - handling draw move
[DrawingEngine] âœ… Updating drawing
[DrawingEngine] Returning TRUE to block other interactions
[Chart] handleMouseMove - DrawingEngine blocking interaction (drawing in progress)
[Chart] â†’ Skipping pan and hover updates
```

#### åœºæ™¯ B: é—®é¢˜åœºæ™¯ï¼ˆå›¾è¡¨ä»ç„¶å¹³ç§»ï¼‰

å¦‚æœçœ‹åˆ°ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼š

```
âŒ [DrawingEngine] Coordinate transforms available: { screenToWorld: false, ... }
   â†’ åæ ‡è½¬æ¢æœªè®¾ç½®

âŒ [DrawingEngine] tool found: NOT FOUND
   â†’ å·¥å…·IDä¸åŒ¹é…

âŒ [DrawingEngine] handleMouseMove - mode: idle
   â†’ æ²¡æœ‰è¿›å…¥ç»˜å›¾æ¨¡å¼

âŒ [Chart] handleMouseMove - Pan mode active (isDragging = true)
   â†’ é”™è¯¯åœ°è¿›å…¥äº†å¹³ç§»æ¨¡å¼
```

## å¦‚ä½•ä½¿ç”¨è°ƒè¯•æ—¥å¿—

### æ­¥éª¤ 1: æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°

- Chrome/Edge: F12 æˆ– Ctrl+Shift+I (Windows) / Cmd+Option+I (Mac)
- Firefox: F12 æˆ– Ctrl+Shift+K (Windows) / Cmd+Option+K (Mac)
- Safari: Cmd+Option+C (éœ€è¦å…ˆåœ¨åå¥½è®¾ç½®ä¸­å¯ç”¨å¼€å‘è€…èœå•)

### æ­¥éª¤ 2: æ¸…ç©ºæ§åˆ¶å°

ç‚¹å‡»æ§åˆ¶å°å·¦ä¸Šè§’çš„ ğŸš« å›¾æ ‡æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—ã€‚

### æ­¥éª¤ 3: æ‰§è¡Œæ“ä½œ

1. é€‰æ‹©ä¸€ä¸ªç»˜å›¾å·¥å…·ï¼ˆå¦‚è¶‹åŠ¿çº¿ï¼‰
2. åœ¨å›¾è¡¨ä¸Šç‚¹å‡»å¹¶æ‹–åŠ¨
3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º

### æ­¥éª¤ 4: åˆ†ææ—¥å¿—

å¯¹æ¯”å®é™…è¾“å‡ºå’Œ"åœºæ™¯ A: æ­£å¸¸å·¥ä½œ"çš„è¾“å‡ºï¼Œæ‰¾å‡ºå·®å¼‚ã€‚

### æ­¥éª¤ 5: å®šä½é—®é¢˜

æ ¹æ®å·®å¼‚ç±»å‹ï¼Œå‚è€ƒ `DRAWING_TOOLS_DEBUG_GUIDE.md` ä¸­çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†ã€‚

## å¸¸è§é—®é¢˜å¿«é€Ÿè¯Šæ–­

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | æ—¥å¿—ç‰¹å¾ | è§£å†³æ–¹å‘ |
|------|----------|----------|----------|
| å›¾è¡¨ä»ç„¶å¹³ç§» | modeæœªå˜æˆdrawing | `mode: idle` | æ£€æŸ¥handleDrawMouseDown |
| æ— æ³•ç»˜å›¾ | åæ ‡è½¬æ¢æœªè®¾ç½® | `screenToWorld: false` | æ£€æŸ¥renderChartè°ƒç”¨æ—¶æœº |
| å·¥å…·ä¸å“åº” | å·¥å…·IDä¸åŒ¹é… | `tool found: NOT FOUND` | å¯¹é½UIå’ŒDrawingToolsçš„ID |
| æ‹–åŠ¨æ—¶æ— é¢„è§ˆ | handleMouseMoveæœªè¿”å›true | `returned FALSE` | æ£€æŸ¥DrawingEngineçŠ¶æ€æœº |

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ“ä½œ

1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åº”ç”¨
2. æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰
3. é€‰æ‹©ä»»æ„ç»˜å›¾å·¥å…·
4. å°è¯•ç»˜å›¾
5. **å¤åˆ¶å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—å¹¶åˆ†æ**

### å¦‚æœé—®é¢˜ä»å­˜åœ¨

åŸºäºæ§åˆ¶å°æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥å‡†ç¡®å®šä½é—®é¢˜å‡ºåœ¨ï¼š

1. **DrawingEngineåˆå§‹åŒ–** - åæ ‡è½¬æ¢å‡½æ•°æœªè®¾ç½®
2. **å·¥å…·æ³¨å†Œ** - å·¥å…·IDä¸åŒ¹é…
3. **çŠ¶æ€æœº** - modeæ²¡æœ‰æ­£ç¡®åˆ‡æ¢åˆ°drawing
4. **äº‹ä»¶å¤„ç†** - handleMouseMoveè¿”å›å€¼é”™è¯¯
5. **ReactçŠ¶æ€** - selectedDrawingToolå’ŒDrawingEngine.activeToolä¸åŒæ­¥

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœéœ€è¦ç«‹å³è®©ç»˜å›¾åŠŸèƒ½å·¥ä½œï¼Œå¯ä»¥å°è¯•ï¼š

```typescript
// åœ¨handleMouseDownä¸­å¼ºåˆ¶è®¾ç½®æ¨¡å¼
if (selectedDrawingTool !== 'select') {
  console.log('[Chart] Force setting drawing mode');
  // ç¡®ä¿ä¸è®¾ç½®isDragging
  return;
}
```

## æŠ€æœ¯æ¶æ„å›é¡¾

### äº‹ä»¶æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç‚¹å‡»å·¥å…·æŒ‰é’®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ setSelectedDrawingTool(id)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ useEffect ç›‘å¬å˜åŒ–           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ drawingEngine.setTool(id)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ state.activeTool = id       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·åœ¨ç”»å¸ƒä¸ŠmouseDown                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Chart.handleMouseDown               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ DrawingEngine.handleMouseDown       â”‚
        â”‚  - æ£€æŸ¥åæ ‡è½¬æ¢                      â”‚
        â”‚  - æ£€æŸ¥activeTool                   â”‚
        â”‚  - è°ƒç”¨handleDrawMouseDown          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ handleDrawMouseDown                 â”‚
        â”‚  - è·å–å·¥å…·å®šä¹‰                      â”‚
        â”‚  - åˆ›å»ºtempObject                   â”‚
        â”‚  - è®¾ç½®mode = 'drawing'  â­         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Chartæ£€æŸ¥selectedDrawingTool        â”‚
        â”‚  if !== 'select' â†’ return  â­      â”‚
        â”‚  (é˜»æ­¢è®¾ç½®isDragging)                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æ‹–åŠ¨é¼ æ ‡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Chart.handleMouseMove               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ DrawingEngine.handleMouseMove       â”‚
        â”‚  - æ£€æŸ¥mode                         â”‚
        â”‚  if mode === 'drawing'              â”‚
        â”‚    â†’ handleDrawMouseMove            â”‚
        â”‚    â†’ è¿”å›TRUE  â­                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Chartæ”¶åˆ°shouldBlock = true         â”‚
        â”‚  â†’ return (è·³è¿‡å¹³ç§»)  â­            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

â­ = å…³é”®æ£€æŸ¥ç‚¹

## æ€»ç»“

æˆ‘ä»¬å·²ç»æ·»åŠ äº†å®Œæ•´çš„è°ƒè¯•æ—¥å¿—ç³»ç»Ÿï¼Œå¯ä»¥æ¸…æ™°åœ°è¿½è¸ªç»˜å›¾å·¥å…·çš„æ•´ä¸ªäº‹ä»¶æµç¨‹ã€‚ç°åœ¨éœ€è¦ï¼š

1. **æ‰§è¡Œå®é™…æ“ä½œ** - åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•
2. **æ”¶é›†æ—¥å¿—** - å¤åˆ¶æ§åˆ¶å°è¾“å‡º
3. **å¯¹æ¯”åˆ†æ** - æ‰¾å‡ºå’Œé¢„æœŸæµç¨‹çš„å·®å¼‚
4. **å®šä½ä¿®å¤** - æ ¹æ®å·®å¼‚ç‚¹è¿›è¡Œé’ˆå¯¹æ€§ä¿®å¤

ä¸€æ—¦æœ‰å®é™…çš„æ—¥å¿—è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å®šä½é—®é¢˜å¹¶æä¾›ç²¾ç¡®çš„è§£å†³æ–¹æ¡ˆã€‚
