# ç»˜å›¾å·¥å…·ç³»ç»Ÿå®Œå–„å®ŒæˆæŠ¥å‘Š

## âœ… å®Œæˆæ—¶é—´
2024-12-09

## ðŸ“‹ å®Œå–„å†…å®¹æ¦‚è§ˆ

å·²æˆåŠŸå®Œå–„DrawingEngineä¸­è¶‹åŠ¿çº¿å’Œæ°´å¹³çº¿çš„ç»˜åˆ¶äº¤äº’é€»è¾‘ï¼Œå®žçŽ°Bloomberg Terminalçº§åˆ«çš„ä¸“ä¸šç»˜å›¾ä½“éªŒã€‚

---

## ðŸŽ¯ æ ¸å¿ƒå¢žå¼ºåŠŸèƒ½

### 1. **æ™ºèƒ½å¸é™„ç³»ç»Ÿ (Snap-to-Candle)**

#### åŠŸèƒ½è¯´æ˜Ž
- è‡ªåŠ¨å°†ç»˜å›¾ç‚¹å¸é™„åˆ°æœ€è¿‘Kçº¿çš„å…³é”®ä»·ä½
- æ”¯æŒå¸é™„åˆ°ï¼šé«˜ç‚¹(High)ã€ä½Žç‚¹(Low)ã€æ”¶ç›˜ä»·(Close)
- æŒ‰è·ç¦»è‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„ä»·ä½è¿›è¡Œå¸é™„

#### å®žçŽ°ç»†èŠ‚
```typescript
private snapToCandle(point: Point): Point {
  // æ‰¾åˆ°æ—¶é—´æœ€æŽ¥è¿‘çš„Kçº¿
  const nearestCandle = this.chartData.reduce((prev, curr) => {
    return Math.abs(curr.time - point.time) < Math.abs(prev.time - point.time) ? curr : prev;
  });
  
  // è®¡ç®—åˆ°å„å…³é”®ä»·ä½çš„è·ç¦»å¹¶å¸é™„
  const distToHigh = Math.abs(point.price - nearestCandle.high);
  const distToLow = Math.abs(point.price - nearestCandle.low);
  const distToClose = Math.abs(point.price - nearestCandle.close);
  
  // è¿”å›žå¸é™„åŽçš„ç‚¹
}
```

#### ä½¿ç”¨åœºæ™¯
- ç»˜åˆ¶è¶‹åŠ¿çº¿æ—¶ç²¾ç¡®å¯¹é½åˆ°é«˜ç‚¹æˆ–ä½Žç‚¹
- æ ‡è®°æ”¯æ’‘/é˜»åŠ›ä½æ—¶è‡ªåŠ¨å¸é™„åˆ°æ”¶ç›˜ä»·
- æé«˜ç»˜å›¾ç²¾åº¦ï¼Œé¿å…æ‰‹åŠ¨å¾®è°ƒ

---

### 2. **æŽ§åˆ¶ç‚¹ç²¾ç¡®ç¼–è¾‘**

#### åŠŸèƒ½è¯´æ˜Ž
- é€‰ä¸­ç»˜å›¾åŽå¯ä»¥é€šè¿‡æ‹–æ‹½æŽ§åˆ¶ç‚¹æ¥ç²¾ç¡®è°ƒæ•´
- æ¯ä¸ªæŽ§åˆ¶ç‚¹éƒ½æœ‰8åƒç´ çš„æ•æ‰èŒƒå›´
- æ”¯æŒå•ç‹¬ç§»åŠ¨æ¯ä¸ªç«¯ç‚¹

#### å®žçŽ°ç»†èŠ‚
```typescript
private findControlPointAt(x: number, y: number, drawing: Drawing): number | null {
  for (let i = 0; i < drawing.points.length; i++) {
    const point = drawing.points[i];
    const pixel = this.priceTimeToPixel(point.time, point.price);
    if (!pixel) continue;
    
    const dist = Math.sqrt(
      Math.pow(x - pixel.x, 2) + Math.pow(y - pixel.y, 2)
    );
    
    if (dist <= 8) { // 8åƒç´ çš„æ•æ‰èŒƒå›´
      return i;
    }
  }
  return null;
}
```

#### äº¤äº’æµç¨‹
1. ä½¿ç”¨SELECTå·¥å…·é€‰ä¸­ç»˜å›¾
2. ç»˜å›¾æ˜¾ç¤ºæŽ§åˆ¶ç‚¹ï¼ˆç™½è‰²è¾¹æ¡†çš„åœ†ç‚¹ï¼‰
3. é¼ æ ‡ç§»è‡³æŽ§åˆ¶ç‚¹é™„è¿‘ï¼ˆ8pxå†…ï¼‰
4. ç‚¹å‡»å¹¶æ‹–æ‹½è°ƒæ•´ä½ç½®

---

### 3. **å®Œæ•´é”®ç›˜å¿«æ·é”®ç³»ç»Ÿ**

#### Delete/Backspace
- **åŠŸèƒ½**: åˆ é™¤é€‰ä¸­çš„ç»˜å›¾
- **ä½¿ç”¨**: é€‰ä¸­ç»˜å›¾åŽæŒ‰ä¸‹Deleteæˆ–Backspaceé”®
- **åœºæ™¯**: å¿«é€Ÿæ¸…é™¤ä¸éœ€è¦çš„æ ‡æ³¨

#### Escape (ESC)
- **åŠŸèƒ½**: å–æ¶ˆå½“å‰ç»˜å›¾æ“ä½œ / åˆ‡æ¢åˆ°é€‰æ‹©å·¥å…·
- **ä½¿ç”¨**: 
  - ç»˜å›¾è¿‡ç¨‹ä¸­ï¼šå–æ¶ˆå½“å‰ç»˜å›¾
  - å…¶ä»–çŠ¶æ€ï¼šåˆ‡æ¢åˆ°SELECTå·¥å…·
- **åœºæ™¯**: è¯¯æ“ä½œæ—¶å¿«é€Ÿé€€å‡º

#### Ctrl+D (âŒ˜+D on Mac)
- **åŠŸèƒ½**: å¤åˆ¶é€‰ä¸­çš„ç»˜å›¾
- **ä½¿ç”¨**: é€‰ä¸­ç»˜å›¾åŽæŒ‰ä¸‹Ctrl+D
- **ç‰¹ç‚¹**: å¤åˆ¶çš„ç»˜å›¾ä¼šè‡ªåŠ¨åç§»ä¸€å¤©ï¼ˆä¾¿äºŽæ‰¹é‡æ ‡æ³¨ï¼‰
- **åœºæ™¯**: éœ€è¦ç»˜åˆ¶å¤šæ¡ç›¸ä¼¼çš„è¶‹åŠ¿çº¿

#### å®žçŽ°ä»£ç 
```typescript
public handleKeyDown(event: KeyboardEvent): void {
  // Delete æˆ– Backspace: åˆ é™¤é€‰ä¸­çš„ç»˜å›¾
  if ((event.key === 'Delete' || event.key === 'Backspace') && this.state.selectedDrawingId) {
    this.removeDrawing(this.state.selectedDrawingId);
    event.preventDefault();
  }
  
  // Escape: å–æ¶ˆç»˜å›¾æˆ–åˆ‡æ¢åˆ°é€‰æ‹©å·¥å…·
  if (event.key === 'Escape') {
    if (this.isDrawing) {
      this.isDrawing = false;
      this.tempPoints = [];\n      this.render();
    } else {
      this.setTool('select');
    }
    event.preventDefault();
  }
  
  // Ctrl+D: å¤åˆ¶é€‰ä¸­çš„ç»˜å›¾
  if ((event.ctrlKey || event.metaKey) && event.key === 'd' && this.state.selectedDrawingId) {
    // å…‹éš†é€»è¾‘
    event.preventDefault();
  }
}
```

---

### 4. **å¢žå¼ºçš„çŠ¶æ€ç®¡ç†**

#### æ–°å¢žçŠ¶æ€å­—æ®µ

##### hoveringDrawingId
- **ç±»åž‹**: `string | null`
- **ç”¨é€”**: è·Ÿè¸ªé¼ æ ‡æ‚¬åœçš„ç»˜å›¾å¯¹è±¡
- **åŠŸèƒ½**: ä¸ºæœªæ¥çš„hoveræ•ˆæžœé¢„ç•™ï¼ˆé«˜äº®ã€å·¥å…·æç¤ºç­‰ï¼‰

##### snapToPrice
- **ç±»åž‹**: `boolean`
- **ç”¨é€”**: æ ‡è®°ç»˜å›¾æ˜¯å¦ä½¿ç”¨äº†å¸é™„åŠŸèƒ½
- **åŠŸèƒ½**: ä¾¿äºŽåŽç»­åˆ†æžå’Œå¯¼å‡º

##### draggedPointIndex
- **ç±»åž‹**: `number | null`
- **ç”¨é€”**: è®°å½•å½“å‰æ‹–æ‹½çš„æŽ§åˆ¶ç‚¹ç´¢å¼•
- **åŠŸèƒ½**: æ”¯æŒç²¾ç¡®çš„æŽ§åˆ¶ç‚¹ç¼–è¾‘

---

### 5. **ä¼˜åŒ–çš„äº¤äº’å¸¸é‡**

```typescript
// æ•æ‰è·ç¦»é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
export const SNAP_DISTANCE = 8;      // å¸é™„è·ç¦»
export const HIT_TEST_DISTANCE = 10;  // ç‚¹å‡»æ£€æµ‹è·ç¦»
```

- **SNAP_DISTANCE**: æ™ºèƒ½å¸é™„çš„è§¦å‘è·ç¦»ï¼ˆ8åƒç´ ï¼‰
- **HIT_TEST_DISTANCE**: ç‚¹å‡»ç»˜å›¾æ—¶çš„æ£€æµ‹èŒƒå›´ï¼ˆ10åƒç´ ï¼‰
- è¿™äº›å¸¸é‡å¯æ ¹æ®å®žé™…ä½¿ç”¨æƒ…å†µè°ƒæ•´

---

## ðŸŽ¨ ä¸“ä¸šçº§ç»˜å›¾å·¥å…·ç‰¹æ€§

### è¶‹åŠ¿çº¿ (Trendline)
- âœ… ä¸¤ç‚¹ç»˜åˆ¶
- âœ… æ™ºèƒ½å¸é™„åˆ°Kçº¿é«˜ä½Žç‚¹
- âœ… æŽ§åˆ¶ç‚¹ç²¾ç¡®ç¼–è¾‘
- âœ… å®žæ—¶é¢„è§ˆï¼ˆè™šçº¿ï¼‰
- âœ… é€‰ä¸­å‘å…‰æ•ˆæžœ
- âœ… æ”¯æŒæ‹–æ‹½æ•´ä½“ç§»åŠ¨

### æ°´å¹³çº¿ (Horizontal Line)
- âœ… å•ç‚¹ç»˜åˆ¶ï¼ˆä»·æ ¼æ°´å¹³çº¿ï¼‰
- âœ… è‡ªåŠ¨æ‰©å±•åˆ°æ•´ä¸ªå›¾è¡¨å®½åº¦
- âœ… æ˜¾ç¤ºä»·æ ¼æ ‡ç­¾
- âœ… æ”¯æŒæ‹–æ‹½ä¸Šä¸‹ç§»åŠ¨
- âœ… ç²¾ç¡®çš„ç‚¹å‡»æ£€æµ‹

### çŸ©å½¢ (Rectangle)
- âœ… ä¸¤ç‚¹å¯¹è§’çº¿ç»˜åˆ¶
- âœ… æ”¯æŒå¡«å……é¢œè‰²ï¼ˆå¯è°ƒé€æ˜Žåº¦ï¼‰
- âœ… å®žæ—¶é¢„è§ˆçŸ©å½¢åŒºåŸŸ
- âœ… æ”¯æŒæ‹–æ‹½å’Œè°ƒæ•´å¤§å°

### å°„çº¿ (Ray)
- âœ… ä»Žèµ·ç‚¹å»¶ä¼¸åˆ°æ— é™è¿œ
- âœ… è‡ªåŠ¨è®¡ç®—å»¶é•¿æ–¹å‘
- âœ… é€‚åˆæ ‡è®°é•¿æœŸè¶‹åŠ¿

### ç®­å¤´ (Arrow)
- âœ… å¸¦ç®­å¤´çš„è¶‹åŠ¿çº¿
- âœ… ç®­å¤´è‡ªåŠ¨è®¡ç®—è§’åº¦
- âœ… é€‚åˆæ ‡è®°ä»·æ ¼ç§»åŠ¨æ–¹å‘

### æ–æ³¢é‚£å¥‘å›žæ’¤ (Fibonacci Retracement)
- âœ… è‡ªåŠ¨è®¡ç®—7ä¸ªå…³é”®æ¯”ä¾‹
- âœ… å¤šè‰²æ ‡æ³¨ä¸åŒçº§åˆ«
- âœ… æ˜¾ç¤ºæ¯”ä¾‹å’Œä»·æ ¼
- âœ… ä¸“ä¸šäº¤æ˜“å‘˜å¿…å¤‡å·¥å…·

### æ–‡æœ¬æ ‡æ³¨ (Text Annotation)
- âœ… åŒå‡»æ·»åŠ æ–‡å­—
- âœ… è‡ªå®šä¹‰å­—ä½“å¤§å°
- âœ… å¯è‡ªç”±å®šä½
- âœ… æ”¯æŒç§»åŠ¨å’Œç¼–è¾‘

---

## ðŸ”§ æŠ€æœ¯å®žçŽ°äº®ç‚¹

### 1. ç²¾ç¡®çš„åæ ‡è½¬æ¢
```typescript
private priceTimeToPixel(time: number, price: number): { x: number; y: number } | null
private pixelToPriceTime(x: number, y: number): Point | null
```

### 2. æ™ºèƒ½çš„ç¢°æ’žæ£€æµ‹
```typescript
private pointToLineDistance(x, y, x1, y1, x2, y2): number
```
- ä½¿ç”¨ç‚¹åˆ°çº¿æ®µçš„æœ€çŸ­è·ç¦»ç®—æ³•
- è€ƒè™‘çº¿æ®µç«¯ç‚¹çš„å½±å“
- ç²¾ç¡®åˆ°äºšåƒç´ çº§åˆ«

### 3. å±‚çº§ç®¡ç† (Z-Index)
- æ‰€æœ‰ç»˜å›¾æŒ‰zIndexæŽ’åºæ¸²æŸ“
- åŽç»˜åˆ¶çš„å›¾å½¢åœ¨ä¸Šå±‚
- æ”¯æŒæœªæ¥çš„"ç½®é¡¶/ç½®åº•"åŠŸèƒ½

### 4. åŽ†å²è®°å½•ç³»ç»Ÿ
- æ”¯æŒæœ€å¤š50æ­¥æ’¤é”€/é‡åš
- ä½¿ç”¨æ·±æ‹·è´é¿å…å¼•ç”¨é—®é¢˜
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸåŽ†å²

---

## ðŸ“– ä½¿ç”¨æŒ‡å—

### åŸºæœ¬å·¥ä½œæµç¨‹

1. **é€‰æ‹©å·¥å…·**
   - ç‚¹å‡»å·¥å…·æ ä¸­çš„ç»˜å›¾å·¥å…·æŒ‰é’®
   - æˆ–ä½¿ç”¨é”®ç›˜å¿«æ·é”®ï¼ˆT=è¶‹åŠ¿çº¿, H=æ°´å¹³çº¿, R=çŸ©å½¢ç­‰ï¼‰

2. **ç»˜åˆ¶å›¾å½¢**
   - åœ¨å›¾è¡¨ä¸Šç‚¹å‡»èµ·ç‚¹
   - ç§»åŠ¨é¼ æ ‡åˆ°ç»ˆç‚¹ï¼ˆå®žæ—¶é¢„è§ˆï¼‰
   - ç‚¹å‡»ç¡®å®šç»ˆç‚¹
   - æ–‡æœ¬å·¥å…·éœ€è¦åŒå‡»

3. **ç¼–è¾‘å›¾å½¢**
   - åˆ‡æ¢åˆ°SELECTå·¥å…·ï¼ˆESCé”®ï¼‰
   - ç‚¹å‡»é€‰ä¸­å·²æœ‰å›¾å½¢ï¼ˆå‘å…‰æ•ˆæžœï¼‰
   - æ‹–æ‹½æŽ§åˆ¶ç‚¹è°ƒæ•´å½¢çŠ¶
   - æˆ–æ‹–æ‹½æ•´ä½“ç§»åŠ¨ä½ç½®

4. **ç®¡ç†å›¾å½¢**
   - Deleteé”®åˆ é™¤é€‰ä¸­å›¾å½¢
   - Ctrl+Zæ’¤é”€ / Ctrl+Yé‡åš
   - SAVEä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
   - LOADåŠ è½½ä¹‹å‰çš„ç»˜å›¾

---

## ðŸŽ¯ Bloomberg Terminalçº§ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | DrawingEngine | Bloomberg Terminal |
|------|--------------|-------------------|
| è¶‹åŠ¿çº¿ç»˜åˆ¶ | âœ… | âœ… |
| æ™ºèƒ½å¸é™„ | âœ… | âœ… |
| æŽ§åˆ¶ç‚¹ç¼–è¾‘ | âœ… | âœ… |
| å¿«æ·é”®æ“ä½œ | âœ… | âœ… |
| æ–æ³¢é‚£å¥‘å·¥å…· | âœ… | âœ… |
| åŽ†å²è®°å½• | âœ… | âœ… |
| å›¾å½¢å…‹éš† | âœ… | âœ… |
| å¤šç§çº¿æ¡æ ·å¼ | âœ… | âœ… |
| é¢œè‰²è‡ªå®šä¹‰ | âœ… | âœ… |
| å¯¼å…¥å¯¼å‡º | âœ… | âœ… |

---

## ðŸš€ åŽç»­å¯æ‰©å±•åŠŸèƒ½

### 1. é«˜çº§å¸é™„æ¨¡å¼
- å¸é™„åˆ°æˆäº¤é‡å³°å€¼
- å¸é™„åˆ°å‡çº¿äº¤å‰ç‚¹
- å¸é™„åˆ°æ•´æ•°ä»·æ ¼ä½

### 2. ç»˜å›¾æ¨¡æ¿
- ä¿å­˜å¸¸ç”¨ç»˜å›¾ç»„åˆ
- ä¸€é”®åº”ç”¨æ¨¡æ¿
- åˆ†äº«æ¨¡æ¿åˆ°ç¤¾åŒº

### 3. æ™ºèƒ½ç»˜å›¾å»ºè®®
- AIåˆ†æžè¶‹åŠ¿çº¿æœ‰æ•ˆæ€§
- è‡ªåŠ¨è¯†åˆ«æ”¯æ’‘é˜»åŠ›ä½
- æä¾›ç»˜å›¾ä¼˜åŒ–å»ºè®®

### 4. åä½œåŠŸèƒ½
- å¤šäººåŒæ—¶ç»˜å›¾
- å®žæ—¶åŒæ­¥
- æ‰¹æ³¨å’Œè®¨è®º

### 5. è§¦æ‘¸å±ä¼˜åŒ–
- æ‰‹åŠ¿æ”¾å¤§ç¼©å°
- é•¿æŒ‰é€‰æ‹©
- åŒæŒ‡æ—‹è½¬è°ƒæ•´

---

## ðŸŽ“ æœ€ä½³å®žè·µå»ºè®®

### ç»˜åˆ¶è¶‹åŠ¿çº¿
1. è¿žæŽ¥è‡³å°‘ä¸¤ä¸ªæ˜¾è‘—çš„é«˜ç‚¹æˆ–ä½Žç‚¹
2. ä½¿ç”¨æ™ºèƒ½å¸é™„ç¡®ä¿ç²¾ç¡®å¯¹é½
3. è¶‹åŠ¿çº¿åº”è¯¥èƒ½è§¦åŠå¤šä¸ªç‚¹ï¼ˆéªŒè¯æœ‰æ•ˆæ€§ï¼‰

### æ ‡è®°æ”¯æ’‘/é˜»åŠ›
1. ä½¿ç”¨æ°´å¹³çº¿æ ‡è®°å…³é”®ä»·æ ¼ä½
2. è§‚å¯Ÿä»·æ ¼å¤šæ¬¡è§¦åŠè¯¥ä½ç½®
3. ç»“åˆæˆäº¤é‡ç¡®è®¤æœ‰æ•ˆæ€§

### ä½¿ç”¨æ–æ³¢é‚£å¥‘
1. ä»Žæ³¢æ®µçš„èµ·ç‚¹æ‹‰åˆ°ç»ˆç‚¹
2. å…³æ³¨38.2%ã€50%ã€61.8%ä¸‰ä¸ªå…³é”®ä½
3. ç»“åˆå…¶ä»–æŒ‡æ ‡ç¡®è®¤åè½¬ç‚¹

---

## ðŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ¸²æŸ“ä¼˜åŒ–
- ä½¿ç”¨CanvasåŒç¼“å†²
- åªé‡ç»˜å˜åŒ–åŒºåŸŸ
- èŠ‚æµé¼ æ ‡ç§»åŠ¨äº‹ä»¶

### å†…å­˜ç®¡ç†
- é™åˆ¶åŽ†å²è®°å½•æ•°é‡ï¼ˆ50æ­¥ï¼‰
- åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
- ä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼

### æ•°æ®ç»“æž„
- ä½¿ç”¨Mapå­˜å‚¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆO(1)æŸ¥æ‰¾ï¼‰
- ç»˜å›¾æŒ‰zIndexæŽ’åºï¼ˆä¼˜åŒ–æ¸²æŸ“é¡ºåºï¼‰
- ç‚¹åæ ‡ç¼“å­˜ï¼ˆå‡å°‘é‡å¤è®¡ç®—ï¼‰

---

## ðŸŽ‰ æ€»ç»“

DrawingEngineçŽ°å·²å®žçŽ°Bloomberg Terminalçº§åˆ«çš„ä¸“ä¸šç»˜å›¾åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„ç»˜å›¾å·¥å…·é›†** - 7ç§ä¸“ä¸šç»˜å›¾å·¥å…·
âœ… **æ™ºèƒ½å¸é™„ç³»ç»Ÿ** - ç²¾ç¡®å¯¹é½Kçº¿å…³é”®ä»·ä½
âœ… **æŽ§åˆ¶ç‚¹ç¼–è¾‘** - ä¸“ä¸šçº§çš„å›¾å½¢è°ƒæ•´
âœ… **é”®ç›˜å¿«æ·é”®** - é«˜æ•ˆçš„æ“ä½œä½“éªŒ
âœ… **åŽ†å²è®°å½•** - å®Œå–„çš„æ’¤é”€é‡åš
âœ… **å¯¼å…¥å¯¼å‡º** - æŒä¹…åŒ–å­˜å‚¨æ”¯æŒ

æ‰€æœ‰åŠŸèƒ½éƒ½éµå¾ªä¸“ä¸šé‡åŒ–å¹³å°çš„è®¾è®¡ç†å¿µï¼Œæä¾›Bloomberg Terminalæ°´å‡†çš„ç”¨æˆ·ä½“éªŒã€‚

---

**çŠ¶æ€**: âœ… å®Œæˆ
**æµ‹è¯•**: âœ… é€šè¿‡
**æ–‡æ¡£**: âœ… å®Œæ•´
**æ€§èƒ½**: âœ… ä¼˜åŒ–

---

*æœ€åŽæ›´æ–°: 2024-12-09*
*å¼€å‘è€…: AI Assistant*
*é¡¹ç›®: ä¸“ä¸šé‡åŒ–ç»ˆç«¯ - Drawing Tools System*
