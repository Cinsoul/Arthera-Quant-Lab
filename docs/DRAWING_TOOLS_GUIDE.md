# 绘图工具使用指南 - Drawing Tools Guide

## 🎯 概述

EnhancedTradingChartV2 已完整集成专业级绘图工具系统，支持TradingView/Bloomberg标准的绘图功能。

## ✅ 已实现的绘图工具

### 1. 选择工具 (SELECT)
- **快捷键**: ESC
- **功能**: 选择、移动、调整已绘制的图形
- **操作**: 
  - 点击图形进行选择
  - 拖动图形进行移动
  - 拖动控制点调整大小
  - Delete/Backspace 删除选中图形

### 2. 趋势线 (TRENDLINE)
- **快捷键**: 无（点击工具栏激活）
- **功能**: 绘制两点之间的直线
- **操作**:
  1. 点击工具栏的 TRENDLINE 按钮
  2. 在图表上点击第一个点
  3. 移动鼠标到第二个点
  4. 点击完成绘制
- **特性**:
  - 世界坐标系统（与K线数据绑定）
  - 缩放和平移时保持位置准确

### 3. 水平线 (HLINE)
- **功能**: 绘制横跨整个图表的水平支撑/阻力线
- **操作**:
  1. 点击工具栏的 HLINE 按钮
  2. 在图表上点击一次即可完成
- **特性**:
  - 自动显示价格标签
  - 支持虚线样式

### 4. 垂直线 (VLINE)
- **功能**: 绘制纵向的时间标记线
- **操作**:
  1. 点击工具栏的 VLINE 按钮
  2. 在图表上点击一次即可完成
- **特性**:
  - 跨越所有 pane（价格区和成交量区）
  - 用于标记重要时间节点

### 5. 射线 (RAY)
- **功能**: 从起点延伸到无限远的趋势线
- **操作**:
  1. 点击工具栏的 RAY 按钮
  2. 点击起点
  3. 点击方向点完成
- **特性**:
  - 自动延伸到画布边缘
  - 适合长期趋势分析

### 6. 矩形 (RECT)
- **功能**: 绘制矩形区域标注
- **操作**:
  1. 点击工具栏的 RECT 按钮
  2. 点击第一个角
  3. 拖动到对角点击完成
- **特性**:
  - 半透明填充
  - 可用于框选重要价格区间

### 7. 箭头 (ARROW)
- **功能**: 带箭头的方向标注
- **操作**:
  1. 点击工具栏的 ARROW 按钮
  2. 点击起点
  3. 点击终点完成
- **特性**:
  - 自动绘制箭头
  - 适合标注买卖信号

### 8. 斐波那契回撤 (FIBONACCI)
- **功能**: 绘制斐波那契回调线
- **操作**:
  1. 点击工具栏的 FIBONACCI 按钮
  2. 点击趋势起点
  3. 点击趋势终点完成
- **特性**:
  - 自动计算 0%, 23.6%, 38.2%, 50%, 61.8%, 78.6%, 100% 回调位
  - 显示价格标签和百分比
  - 不同回调位使用不同颜色

### 9. 文本标注 (TEXT)
- **功能**: 在图表上添加文字说明
- **操作**:
  1. 点击工具栏的 TEXT 按钮
  2. 在图表上点击位置
  3. 在弹出的对话框中输入文本
- **特性**:
  - 自定义字体大小
  - 支持颜色设置

## 🎨 绘图工具位置

绘图工具栏位于图表左侧，包含以下分类：
- **SELECTOR**: 选择工具
- **LINES**: 线条工具（趋势线、水平线、垂直线、射线）
- **SHAPES**: 形状工具（矩形）
- **TECHNICAL**: 技术分析工具（斐波那契、平行通道、三线图等）
- **ANNOTATIONS**: 标注工具（箭头、文本等）

## ⌨️ 键盘快捷键

### 全局快捷键
- **ESC**: 切换到选择工具 / 取消当前操作
- **Delete / Backspace**: 删除选中的图形
- **Ctrl+Z / Cmd+Z**: 撤销
- **Ctrl+Shift+Z / Ctrl+Y / Cmd+Y**: 重做

### 调试快捷键（开发模式）
- **Ctrl+Shift+V**: 切换调试面板显示（可以看到绘图数量、性能指标等）
- **Ctrl+Shift+D**: 切换调试日志
- **Ctrl+Shift+P**: 切换性能监控

## 🔧 技术细节

### 架构设计
```
EnhancedTradingChartV2 (主图表组件)
  ├── DrawingEngineV2 (绘图引擎核心)
  │   ├── DrawingTools.ts (工具定义)
  │   ├── DrawingTypes.ts (类型定义)
  │   └── 状态管理、事件处理、渲染
  └── 内置工具栏 UI
```

### 核心特性

#### 1. 世界坐标系统
- 所有绘图对象使用世界坐标 `WorldPoint { t: timestamp, p: price }`
- 与K线数据绑定，缩放和平移时保持准确位置
- 自动转换屏幕坐标和世界坐标

#### 2. 状态机交互模式
```
idle (空闲)
  → drawing (绘图中)
  → editing (编辑/移动)
  → resizing (调整大小)
```

#### 3. 专业命中测试
- 精确的点线距离计算
- 控制点优先检测
- Z-index 分层渲染

#### 4. 撤销/重做系统
- 最多保存 50 步历史记录
- 自动管理撤销栈和重做栈
- 支持快捷键操作

## 🐛 故障排除

### 问题：绘图工具不响应点击
**解决方案**:
1. 检查是否已选择正确的工具（不是 SELECT）
2. 确保点击在图表内部区域
3. 按 `Ctrl+Shift+V` 打开调试面板，查看 DrawingEngine 是否初始化

### 问题：绘制的线条位置不准确
**解决方案**:
1. 这可能是坐标转换问题
2. 检查 viewportManagerRef 是否正常工作
3. 查看控制台是否有坐标转换相关错误

### 问题：看不到绘图工具栏
**解决方案**:
1. 确保图表有足够的宽度显示左侧工具栏
2. 检查容器的 overflow 设置
3. 工具栏是内置在 EnhancedTradingChartV2 中的，无需额外引入

### 问题：绘图后图形消失
**解决方案**:
1. 检查是否完成了绘制（例如趋势线需要两次点击）
2. 查看调试面板中的 "Drawing Count" 是否增加
3. 确认没有立即按 ESC 取消操作

## 📊 使用示例

### 标记支撑位和阻力位
```
1. 选择 HLINE 工具
2. 点击关键价格位置
3. 重复步骤 1-2 标记多个支撑/阻力位
4. 使用 SELECT 工具调整位置
```

### 绘制趋势通道
```
1. 选择 TRENDLINE 工具
2. 沿趋势底部绘制第一条趋势线
3. 再次选择 TRENDLINE 工具
4. 沿趋势顶部绘制平行趋势线
```

### 斐波那契回撤分析
```
1. 选择 FIBONACCI 工具
2. 点击趋势起点（波段低点）
3. 点击趋势终点（波段高点）
4. 自动显示所有回调位和价格
```

## 🚀 后续优化方向

### 已完成 ✅
- [x] 基础绘图工具（趋势线、水平线、垂直线等）
- [x] 世界坐标系统
- [x] 撤销/重做功能
- [x] 选择和编辑功能
- [x] 键盘快捷键
- [x] 调试面板集成

### 计划中 📋
- [ ] 绘图样式自定义面板（颜色、线宽、虚线样式）
- [ ] 绘图对象列表管理
- [ ] 绘图保存/加载（导出为 JSON）
- [ ] 更多技术分析工具（甘恩线、回归通道等）
- [ ] 绘图对象复制/粘贴
- [ ] 磁吸功能（自动对齐到K线）
- [ ] 绘图模板系统

## 📝 注意事项

1. **性能优化**: 当绘图对象超过 100 个时，可能会影响渲染性能
2. **坐标精度**: 使用世界坐标系统，缩放和平移不会影响绘图位置
3. **交互优先级**: 绘图工具激活时会阻止图表平移，按 ESC 切回 SELECT 工具即可恢复平移
4. **持久化**: 当前绘图对象仅保存在内存中，刷新页面会丢失（计划添加本地存储）

## 🎓 Bloomberg Terminal 专业级设计

本绘图系统参考了 Bloomberg Terminal 和 TradingView 的设计理念：

1. **无图标设计**: 使用专业文本标签，提高信息密度
2. **深蓝色系**: 符合金融终端的专业风格
3. **快捷键优先**: 专业交易员习惯使用键盘操作
4. **命令行集成**: 可通过控制台命令启用/禁用调试模式
5. **实时性能监控**: 内置调试面板显示 FPS、渲染时间等指标

---

**最后更新**: 2024-12-10
**版本**: V2.0
**状态**: ✅ 生产就绪
